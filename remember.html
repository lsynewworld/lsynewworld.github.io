<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的朋友圈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#4080FF',
                        neutral: {
                            100: '#F5F7FA',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-scale {
                transition: transform 0.2s ease;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            .image-grid {
                display: grid;
                grid-gap: 4px;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .timeline-item::before {
                content: '';
                position: absolute;
                left: 24px;
                top: 0;
                bottom: 0;
                width: 2px;
                background-color: #E5E6EB;
            }
            .timeline-dot {
                position: absolute;
                left: 18px;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background-color: #165DFF;
                z-index: 10;
            }
        }
    </style>
</head>
<body class="bg-neutral-100 font-inter text-neutral-700 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-primary flex items-center">
                    <i class="fa fa-paper-plane-o mr-2"></i>
                    <span>我的朋友圈</span>
                </h1>
                <div class="flex space-x-2">
                    <button id="timeline-view-btn" class="px-3 py-1 rounded-md text-sm bg-primary text-white">时间线</button>
                    <button id="list-view-btn" class="px-3 py-1 rounded-md text-sm bg-neutral-200 text-neutral-600">列表</button>
                </div>
            </div>
            <button id="add-post-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-full flex items-center transition-all duration-300 shadow-md hover:shadow-lg">
                <i class="fa fa-plus-circle mr-2"></i>
                <span>发动态</span>
            </button>
        </div>
    </header>

    <!-- 筛选器 -->
    <div id="timeline-filter" class="fixed top-16 left-0 right-0 bg-white border-b border-neutral-200 z-40 px-4 py-2 hidden">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex space-x-2 overflow-x-auto pb-1 hide-scrollbar">
                <button class="time-filter-btn px-3 py-1 rounded-md text-sm bg-primary text-white whitespace-nowrap">全部</button>
                <!-- 时间筛选按钮将通过JavaScript动态添加 -->
            </div>
            <button id="close-timeline-filter" class="text-neutral-500 hover:text-neutral-700">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-16">
        <!-- 动态列表视图 -->
        <div id="posts-container" class="max-w-4xl mx-auto space-y-6">
            <!-- 动态内容将通过JavaScript动态添加 -->
        </div>

        <!-- 时间线视图 -->
        <div id="timeline-container" class="max-w-4xl mx-auto space-y-8 pt-6 hidden">
            <!-- 时间线内容将通过JavaScript动态添加 -->
        </div>

        <!-- 空状态 -->
        <div id="empty-state" class="max-w-4xl mx-auto py-16 text-center hidden">
            <div class="bg-white rounded-xl p-8 shadow-lg max-w-md mx-auto">
                <div class="text-neutral-400 text-6xl mb-4">
                    <i class="fa fa-file-text-o"></i>
                </div>
                <h3 class="text-xl font-semibold text-neutral-600 mb-2">暂无动态</h3>
                <p class="text-neutral-500 mb-6">点击上方"发动态"按钮，开始记录你的生活点滴</p>
                <button id="empty-add-btn" class="bg-primary hover:bg-secondary text-white px-6 py-3 rounded-full flex items-center mx-auto transition-all duration-300 shadow-md hover:shadow-lg">
                    <i class="fa fa-plus-circle mr-2"></i>
                    <span>发第一条动态</span>
                </button>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-neutral-200 py-4">
        <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
            <p>© 2025 我的朋友圈应用 | 所有内容保存在本地</p>
        </div>
    </footer>

    <!-- 新增动态模态框 -->
    <div id="add-post-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden shadow-xl animate-fade-in h-[90vh] flex flex-col">
            <div class="border-b border-neutral-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-neutral-700">发布动态</h3>
                <button id="close-modal-btn" class="text-neutral-500 hover:text-neutral-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-4">
                    <textarea id="post-content" rows="4" placeholder="分享你的想法..." class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-neutral-700 mb-2">添加图片 (最多9张)</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="file-upload" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-neutral-300 rounded-lg cursor-pointer bg-neutral-100 hover:bg-neutral-200 transition-all">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fa fa-cloud-upload text-3xl text-neutral-400 mb-2"></i>
                                <p class="mb-2 text-sm text-neutral-500"><span class="font-medium">点击上传图片</span> 或拖放</p>
                                <p class="text-xs text-neutral-400">支持 PNG, JPG, GIF 格式</p>
                            </div>
                            <input id="file-upload" type="file" accept="image/*" multiple class="hidden" />
                        </label>
                    </div>
                    <div id="image-previews" class="mt-4 grid grid-cols-3 gap-2 hidden">
                        <!-- 图片预览将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>
            <div class="border-t border-neutral-200 p-4">
                <button id="save-post-btn" class="w-full bg-primary hover:bg-secondary text-white font-medium py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg">
                    发布
                </button>
            </div>
        </div>
    </div>

    <!-- 评论模态框 -->
    <div id="comments-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl w-full max-w-lg mx-4 overflow-hidden shadow-xl animate-fade-in h-[80vh] flex flex-col">
            <div class="border-b border-neutral-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-neutral-700">评论</h3>
                <button id="close-comments-btn" class="text-neutral-500 hover:text-neutral-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="comments-container" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- 评论内容将通过JavaScript动态添加 -->
            </div>
            <div class="border-t border-neutral-200 p-4">
                <div class="flex items-center space-x-2">
                    <input id="comment-input" type="text" placeholder="添加评论..." class="flex-1 px-4 py-2 border border-neutral-300 rounded-full focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    <button id="add-comment-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-full transition-all">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="image-viewer-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="relative w-full max-w-4xl px-4">
            <button id="close-image-viewer" class="absolute top-4 right-4 text-white text-2xl hover:text-neutral-300">
                <i class="fa fa-times"></i>
            </button>
            <div class="flex items-center justify-between h-full">
                <button id="prev-image" class="absolute left-4 text-white text-3xl hover:text-neutral-300">
                    <i class="fa fa-angle-left"></i>
                </button>
                <img id="fullsize-image" class="max-h-[80vh] max-w-full object-contain" alt="大图预览">
                <button id="next-image" class="absolute right-4 text-white text-3xl hover:text-neutral-300">
                    <i class="fa fa-angle-right"></i>
                </button>
            </div>
            <div class="absolute bottom-4 left-0 right-0 text-center text-white">
                <span id="image-caption"></span>
                <span id="image-counter" class="ml-2 text-sm"></span>
            </div>
        </div>
    </div>

    <script>
        // 数据结构
        let posts = [];
        let currentPostId = null;
        let currentImageIndex = 0;
        let currentImages = [];
        let db = null;
        let accountName = '我的账号'; // 默认账号名
        let currentView = 'list'; // 'list' 或 'timeline'
        let currentFilter = 'all'; // 默认显示所有

        // DOM 元素
        const postsContainer = document.getElementById('posts-container');
        const timelineContainer = document.getElementById('timeline-container');
        const emptyState = document.getElementById('empty-state');
        const addPostBtn = document.getElementById('add-post-btn');
        const emptyAddBtn = document.getElementById('empty-add-btn');
        const addPostModal = document.getElementById('add-post-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const postContent = document.getElementById('post-content');
        const fileUpload = document.getElementById('file-upload');
        const imagePreviews = document.getElementById('image-previews');
        const savePostBtn = document.getElementById('save-post-btn');
        const commentsModal = document.getElementById('comments-modal');
        const closeCommentsBtn = document.getElementById('close-comments-btn');
        const commentsContainer = document.getElementById('comments-container');
        const commentInput = document.getElementById('comment-input');
        const addCommentBtn = document.getElementById('add-comment-btn');
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const closeImageViewer = document.getElementById('close-image-viewer');
        const fullsizeImage = document.getElementById('fullsize-image');
        const imageCaption = document.getElementById('image-caption');
        const imageCounter = document.getElementById('image-counter');
        const prevImageBtn = document.getElementById('prev-image');
        const nextImageBtn = document.getElementById('next-image');
        const timelineViewBtn = document.getElementById('timeline-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const timelineFilter = document.getElementById('timeline-filter');
        const closeTimelineFilter = document.getElementById('close-timeline-filter');

        // 初始化IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                console.log('尝试打开数据库...');
                const request = indexedDB.open('FriendCircleDB', 1);
                
                request.onupgradeneeded = function(event) {
                    console.log('数据库升级中...');
                    db = event.target.result;
                    
                    // 创建对象存储空间
                    if (!db.objectStoreNames.contains('posts')) {
                        const objectStore = db.createObjectStore('posts', { keyPath: 'id' });
                        
                        // 创建索引
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('创建了posts对象存储空间');
                    }
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('数据库初始化成功');
                    resolve();
                };
                
                request.onerror = function(event) {
                    console.error('数据库打开失败:', event.target.error);
                    alert('数据库初始化失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
                
                request.onblocked = function(event) {
                    console.error('数据库被阻塞:', event.target.error);
                    alert('数据库被占用，请关闭其他打开此数据库的页面后重试');
                    reject(event.target.error);
                };
            });
        }

        // 加载已保存的动态
        async function loadPosts() {
            posts = [];
            
            return new Promise((resolve, reject) => {
                console.log('尝试加载动态...');
                if (!db) {
                    console.error('数据库未初始化');
                    reject(new Error('数据库未初始化'));
                    return;
                }
                
                const transaction = db.transaction(['posts'], 'readonly');
                const objectStore = transaction.objectStore('posts');
                const request = objectStore.getAll();
                
                request.onsuccess = function(event) {
                    posts = event.target.result || [];
                    console.log(`成功加载 ${posts.length} 条动态`);
                    
                    // 按时间戳排序（最新的在前）
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // 更新时间线筛选器
                    updateTimelineFilters();
                    
                    resolve();
                };
                
                request.onerror = function(event) {
                    console.error('加载动态失败:', event.target.error);
                    alert('加载动态失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
            });
        }

        // 保存动态到IndexedDB
        async function savePost(postData) {
            return new Promise((resolve, reject) => {
                console.log('尝试保存动态...');
                if (!db) {
                    console.error('数据库未初始化');
                    reject(new Error('数据库未初始化'));
                    return;
                }
                
                const transaction = db.transaction(['posts'], 'readwrite');
                const objectStore = transaction.objectStore('posts');
                const request = objectStore.put(postData);
                
                request.onsuccess = function(event) {
                    console.log('动态保存成功');
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('保存动态失败:', event.target.error);
                    alert('保存动态失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
            });
        }

        // 删除动态
        async function deletePostFile(postId) {
            return new Promise((resolve, reject) => {
                console.log('尝试删除动态...');
                if (!db) {
                    console.error('数据库未初始化');
                    reject(new Error('数据库未初始化'));
                    return;
                }
                
                const transaction = db.transaction(['posts'], 'readwrite');
                const objectStore = transaction.objectStore('posts');
                const request = objectStore.delete(postId);
                
                request.onsuccess = function(event) {
                    console.log('动态删除成功');
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('删除动态失败:', event.target.error);
                    alert('删除动态失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
            });
        }

        // 更新时间线筛选器
        function updateTimelineFilters() {
            const timeFilterContainer = timelineFilter.querySelector('.time-filter-btn').parentNode;
            timeFilterContainer.innerHTML = '';
            
            // 添加"全部"按钮
            const allBtn = document.createElement('button');
            allBtn.className = 'time-filter-btn px-3 py-1 rounded-md text-sm bg-primary text-white whitespace-nowrap';
            allBtn.textContent = '全部';
            allBtn.addEventListener('click', () => {
                setTimelineFilter('all');
            });
            timeFilterContainer.appendChild(allBtn);
            
            // 收集所有年月
            const yearMonths = new Set();
            posts.forEach(post => {
                const date = new Date(post.timestamp);
                const yearMonth = `${date.getFullYear()}年${date.getMonth() + 1}月`;
                yearMonths.add(yearMonth);
            });
            
            // 添加年月按钮
            yearMonths.forEach(yearMonth => {
                const btn = document.createElement('button');
                btn.className = 'time-filter-btn px-3 py-1 rounded-md text-sm bg-neutral-200 text-neutral-600 whitespace-nowrap hover:bg-neutral-300 transition-colors';
                btn.textContent = yearMonth;
                btn.addEventListener('click', () => {
                    setTimelineFilter(yearMonth);
                });
                timeFilterContainer.appendChild(btn);
            });
        }

        // 设置时间线筛选器
        function setTimelineFilter(filter) {
            currentFilter = filter;
            
            // 更新按钮样式
            const filterBtns = timelineFilter.querySelectorAll('.time-filter-btn');
            filterBtns.forEach(btn => {
                if (btn.textContent === filter || (filter === 'all' && btn.textContent === '全部')) {
                    btn.classList.remove('bg-neutral-200', 'text-neutral-600');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-neutral-200', 'text-neutral-600');
                }
            });
            
            // 更新显示
            updatePostsDisplay();
        }

        // 切换到时间线视图
        function switchToTimelineView() {
            currentView = 'timeline';
            timelineViewBtn.classList.remove('bg-neutral-200', 'text-neutral-600');
            timelineViewBtn.classList.add('bg-primary', 'text-white');
            listViewBtn.classList.remove('bg-primary', 'text-white');
            listViewBtn.classList.add('bg-neutral-200', 'text-neutral-600');
            postsContainer.classList.add('hidden');
            timelineContainer.classList.remove('hidden');
            timelineFilter.classList.remove('hidden');
            
            // 滚动到顶部
            window.scrollTo(0, 0);
            
            // 更新显示
            updatePostsDisplay();
        }

        // 切换到列表视图
        function switchToListView() {
            currentView = 'list';
            listViewBtn.classList.remove('bg-neutral-200', 'text-neutral-600');
            listViewBtn.classList.add('bg-primary', 'text-white');
            timelineViewBtn.classList.remove('bg-primary', 'text-white');
            timelineViewBtn.classList.add('bg-neutral-200', 'text-neutral-600');
            postsContainer.classList.remove('hidden');
            timelineContainer.classList.add('hidden');
            timelineFilter.classList.add('hidden');
            
            // 滚动到顶部
            window.scrollTo(0, 0);
            
            // 更新显示
            updatePostsDisplay();
        }

        // 更新动态显示
        function updatePostsDisplay() {
            // 清空容器
            postsContainer.innerHTML = '';
            timelineContainer.innerHTML = '';
            
            // 筛选动态
            let filteredPosts = posts;
            if (currentFilter !== 'all') {
                const [yearStr, monthStr] = currentFilter.split('年');
                const year = parseInt(yearStr);
                const month = parseInt(monthStr);
                
                filteredPosts = posts.filter(post => {
                    const date = new Date(post.timestamp);
                    return date.getFullYear() === year && date.getMonth() + 1 === month;
                });
            }
            
            // 检查是否有动态
            if (filteredPosts.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            // 隐藏空状态
            emptyState.classList.add('hidden');
            
            // 根据当前视图渲染
            if (currentView === 'list') {
                // 渲染列表视图
                filteredPosts.forEach(post => {
                    const postElement = createPostElement(post);
                    postsContainer.appendChild(postElement);
                });
            } else {
                // 渲染时间线视图
                const postsByMonth = groupPostsByMonth(filteredPosts);
                
                postsByMonth.forEach(monthGroup => {
                    const monthElement = createMonthGroupElement(monthGroup);
                    timelineContainer.appendChild(monthElement);
                });
            }
        }

        // 按年月分组动态
        function groupPostsByMonth(posts) {
            const groups = {};
            
            posts.forEach(post => {
                const date = new Date(post.timestamp);
                const yearMonth = `${date.getFullYear()}年${date.getMonth() + 1}月`;
                
                if (!groups[yearMonth]) {
                    groups[yearMonth] = {
                        yearMonth,
                        posts: []
                    };
                }
                
                groups[yearMonth].posts.push(post);
            });
            
            return Object.values(groups);
        }

        // 创建月份分组元素
        function createMonthGroupElement(monthGroup) {
            const monthElement = document.createElement('div');
            monthElement.className = 'space-y-6';
            
            // 添加月份标题
            const header = document.createElement('div');
            header.className = 'px-6 py-3 bg-white rounded-lg shadow-sm flex items-center';
            header.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary mr-3">
                    <i class="fa fa-calendar-o"></i>
                </div>
                <h3 class="font-medium text-neutral-700">${monthGroup.yearMonth}</h3>
                <span class="ml-2 text-sm text-neutral-500">${monthGroup.posts.length}条动态</span>
            `;
            monthElement.appendChild(header);
            
            // 添加动态
            monthGroup.posts.forEach((post, index) => {
                const postElement = createTimelinePostElement(post, index === 0);
                monthElement.appendChild(postElement);
            });
            
            return monthElement;
        }

        // 创建时间线动态元素
        function createTimelinePostElement(post, isFirst) {
            const postDate = new Date(post.timestamp);
            const formattedDate = postDate.toLocaleString('zh-CN', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const postElement = document.createElement('div');
            postElement.className = 'timeline-item relative pl-12';
            postElement.dataset.postId = post.id;
            
            // 添加时间点
            const timeDot = document.createElement('div');
            timeDot.className = 'timeline-dot mt-4';
            postElement.appendChild(timeDot);
            
            // 动态内容
            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'bg-white rounded-xl overflow-hidden card-shadow hover-scale animate-fade-in mt-2 mb-4';
            
            // 彻底检查图片URL是否有效
            const hasValidImages = post.imageUrls && post.imageUrls.length > 0;
            
            // 检查是否有非空的内容
            const hasContent = post.content && post.content.trim() !== '';
            
            // 动态内容部分（只有在有内容时才生成）
            let contentHtml = '';
            if (hasContent) {
                contentHtml = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <i class="fa fa-user-circle-o text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-neutral-700">${accountName}</h3>
                                    <p class="text-xs text-neutral-400">${formattedDate}</p>
                                </div>
                            </div>
                            <button class="delete-post text-neutral-400 hover:text-neutral-600 transition-colors">
                                <i class="fa fa-trash-o"></i>
                            </button>
                        </div>
                        <p class="text-neutral-700 mb-4">${post.content}</p>
                    </div>
                `;
            }
            
            // 图片部分（仅当有有效图片时生成）
            let imageHtml = '';
            if (hasValidImages) {
                imageHtml = `
                    <div class="p-6 pt-0">
                        <div class="image-grid">
                            ${post.imageUrls.map((url, index) => `
                                <div class="relative group cursor-pointer overflow-hidden rounded-lg" data-index="${index}">
                                    <img src="${url}" alt="动态图片" class="w-full h-24 object-cover hover:opacity-90 transition-opacity">
                                    ${post.imageUrls.length > 1 && index === post.imageUrls.length - 1 && post.imageUrls.length > 4 ? 
                                        `<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">+${post.imageUrls.length - 4}</div>` : ''
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 互动按钮部分（只有在有内容或图片时才生成）
            let actionsHtml = '';
            if (hasContent || hasValidImages) {
                actionsHtml = `
                    <div class="border-t border-neutral-100 px-6 py-3 flex justify-between">
                        <button class="like-post flex items-center space-x-1 text-neutral-500 hover:text-primary transition-colors">
                            <i class="fa fa-heart-o"></i>
                            <span>点赞</span>
                        </button>
                        <button class="add-comment flex items-center space-x-1 text-neutral-500 hover:text-primary transition-colors">
                            <i class="fa fa-comment-o"></i>
                            <span>评论</span>
                        </button>
                    </div>
                `;
            }
            
            // 评论部分（有评论时显示，且仅当有内容或图片时才显示）
            let commentsHtml = '';
            if ((hasContent || hasValidImages) && post.comments && post.comments.length > 0) {
                const limitedComments = post.comments.slice(0, 2); // 只显示最新的两条评论
                commentsHtml = `
                    <div class="px-6 pt-2 pb-4 space-y-2">
                        ${limitedComments.map(comment => `
                            <div class="flex items-start space-x-2">
                                <div class="w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-500 flex-shrink-0">
                                    <i class="fa fa-user"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between">
                                        <p class="text-sm font-medium text-neutral-700">评论者</p>
                                        <p class="text-xs text-neutral-400">${formattedDate}</p>
                                    </div>
                                    <p class="text-sm text-neutral-600">${comment.text}</p>
                                </div>
                            </div>
                        `).join('')}
                        ${post.comments.length > 2 ? 
                            `<button class="text-primary text-sm hover:underline view-all-comments">查看全部 ${post.comments.length} 条评论</button>` : ''
                        }
                    </div>
                `;
            }
            
            // 组合最终的HTML结构
            contentWrapper.innerHTML = contentHtml + imageHtml + actionsHtml + commentsHtml;
            postElement.appendChild(contentWrapper);
            
            // 添加事件监听器
            const deleteBtn = postElement.querySelector('.delete-post');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    handleDeletePost(post.id);
                });
            }
            
            const likeBtn = postElement.querySelector('.like-post');
            if (likeBtn) {
                likeBtn.addEventListener('click', async () => {
                    handleLikePost(post.id);
                });
            }
            
            const commentBtn = postElement.querySelector('.add-comment');
            if (commentBtn) {
                commentBtn.addEventListener('click', async () => {
                    handleShowComments(post.id);
                });
            }
            
            const viewAllCommentsBtn = postElement.querySelector('.view-all-comments');
            if (viewAllCommentsBtn) {
                viewAllCommentsBtn.addEventListener('click', async () => {
                    handleShowComments(post.id);
                });
            }
            
            // 添加图片点击事件
            const imageContainers = postElement.querySelectorAll('.image-grid > div');
            imageContainers.forEach(container => {
                container.addEventListener('click', () => {
                    const index = parseInt(container.dataset.index);
                    openImageViewer(post.imageUrls, index, post.content);
                });
            });
            
            return postElement;
        }

        // 创建动态元素
        function createPostElement(post) {
            const postDate = new Date(post.timestamp);
            const formattedDate = postDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const postElement = document.createElement('article');
            postElement.className = 'bg-white rounded-xl overflow-hidden card-shadow hover-scale animate-fade-in';
            postElement.dataset.postId = post.id;
            
            // 彻底检查图片URL是否有效
            const hasValidImages = post.imageUrls && post.imageUrls.length > 0;
            
            // 检查是否有非空的内容
            const hasContent = post.content && post.content.trim() !== '';
            
            // 动态内容部分（只有在有内容时才生成）
            let contentHtml = '';
            if (hasContent) {
                contentHtml = `
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <i class="fa fa-user-circle-o text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-neutral-700">${accountName}</h3>
                                    <p class="text-xs text-neutral-400">${formattedDate}</p>
                                </div>
                            </div>
                            <button class="delete-post text-neutral-400 hover:text-neutral-600 transition-colors">
                                <i class="fa fa-trash-o"></i>
                            </button>
                        </div>
                        <p class="text-neutral-700 mb-4">${post.content}</p>
                    </div>
                `;
            }
            
            // 图片部分（仅当有有效图片时生成）
            let imageHtml = '';
            if (hasValidImages) {
                imageHtml = `
                    <div class="p-6 pt-0">
                        <div class="image-grid">
                            ${post.imageUrls.map((url, index) => `
                                <div class="relative group cursor-pointer overflow-hidden rounded-lg" data-index="${index}">
                                    <img src="${url}" alt="动态图片" class="w-full h-24 object-cover hover:opacity-90 transition-opacity">
                                    ${post.imageUrls.length > 1 && index === post.imageUrls.length - 1 && post.imageUrls.length > 4 ? 
                                        `<div class="absolute inset-0 bg-black/50 flex items-center justify-center text-white font-bold">+${post.imageUrls.length - 4}</div>` : ''
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 互动按钮部分（只有在有内容或图片时才生成）
            let actionsHtml = '';
            if (hasContent || hasValidImages) {
                actionsHtml = `
                    <div class="border-t border-neutral-100 px-6 py-3 flex justify-between">
                        <button class="like-post flex items-center space-x-1 text-neutral-500 hover:text-primary transition-colors">
                            <i class="fa fa-heart-o"></i>
                            <span>点赞</span>
                        </button>
                        <button class="add-comment flex items-center space-x-1 text-neutral-500 hover:text-primary transition-colors">
                            <i class="fa fa-comment-o"></i>
                            <span>评论</span>
                        </button>
                    </div>
                `;
            }
            
            // 评论部分（有评论时显示，且仅当有内容或图片时才显示）
            let commentsHtml = '';
            if ((hasContent || hasValidImages) && post.comments && post.comments.length > 0) {
                const limitedComments = post.comments.slice(0, 2); // 只显示最新的两条评论
                commentsHtml = `
                    <div class="px-6 pt-2 pb-4 space-y-2">
                        ${limitedComments.map(comment => `
                            <div class="flex items-start space-x-2">
                                <div class="w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-500 flex-shrink-0">
                                    <i class="fa fa-user"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between">
                                        <p class="text-sm font-medium text-neutral-700">评论者</p>
                                        <p class="text-xs text-neutral-400">${formattedDate}</p>
                                    </div>
                                    <p class="text-sm text-neutral-600">${comment.text}</p>
                                </div>
                            </div>
                        `).join('')}
                        ${post.comments.length > 2 ? 
                            `<button class="text-primary text-sm hover:underline view-all-comments">查看全部 ${post.comments.length} 条评论</button>` : ''
                        }
                    </div>
                `;
            }
            
            // 组合最终的HTML结构
            postElement.innerHTML = contentHtml + imageHtml + actionsHtml + commentsHtml;
            
            // 添加事件监听器
            const deleteBtn = postElement.querySelector('.delete-post');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', async () => {
                    handleDeletePost(post.id);
                });
            }
            
            const likeBtn = postElement.querySelector('.like-post');
            if (likeBtn) {
                likeBtn.addEventListener('click', async () => {
                    handleLikePost(post.id);
                });
            }
            
            const commentBtn = postElement.querySelector('.add-comment');
            if (commentBtn) {
                commentBtn.addEventListener('click', async () => {
                    handleShowComments(post.id);
                });
            }
            
            const viewAllCommentsBtn = postElement.querySelector('.view-all-comments');
            if (viewAllCommentsBtn) {
                viewAllCommentsBtn.addEventListener('click', async () => {
                    handleShowComments(post.id);
                });
            }
            
            // 添加图片点击事件
            const imageContainers = postElement.querySelectorAll('.image-grid > div');
            imageContainers.forEach(container => {
                container.addEventListener('click', () => {
                    const index = parseInt(container.dataset.index);
                    openImageViewer(post.imageUrls, index, post.content);
                });
            });
            
            return postElement;
        }

        // 打开图片查看器
        function openImageViewer(images, startIndex, caption) {
            currentImages = images;
            currentImageIndex = startIndex;
            
            updateImageViewer();
            
            imageViewerModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }

        // 关闭图片查看器
        function closeImageViewerModal() {
            imageViewerModal.classList.add('hidden');
            document.body.style.overflow = 'auto'; // 恢复背景滚动
        }

        // 更新图片查看器内容
        function updateImageViewer() {
            if (currentImages.length === 0) return;
            
            fullsizeImage.src = currentImages[currentImageIndex];
            imageCaption.textContent = currentPostId ? posts.find(p => p.id === currentPostId)?.content || '' : '';
            imageCounter.textContent = `${currentImageIndex + 1}/${currentImages.length}`;
            
            // 禁用不可用的按钮
            prevImageBtn.disabled = currentImageIndex === 0;
            nextImageBtn.disabled = currentImageIndex === currentImages.length - 1;
            
            prevImageBtn.classList.toggle('opacity-50', currentImageIndex === 0);
            nextImageBtn.classList.toggle('opacity-50', currentImageIndex === currentImages.length - 1);
        }

        // 显示上一张图片
        function showPrevImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateImageViewer();
            }
        }

        // 显示下一张图片
        function showNextImage() {
            if (currentImageIndex < currentImages.length - 1) {
                currentImageIndex++;
                updateImageViewer();
            }
        }

        // 处理删除动态
        async function handleDeletePost(postId) {
            if (confirm('确定要删除这条动态吗？')) {
                // 从数组中移除
                posts = posts.filter(post => post.id !== postId);
                
                // 删除文件
                await deletePostFile(postId);
                
                // 更新显示
                updatePostsDisplay();
            }
        }

        // 处理点赞动态
        async function handleLikePost(postId) {
            const post = posts.find(post => post.id === postId);
            if (post) {
                post.liked = !post.liked;
                
                // 更新UI
                const postElement = document.querySelector(`article[data-post-id="${postId}"]`);
                const likeBtn = postElement?.querySelector('.like-post');
                
                if (likeBtn) {
                    if (post.liked) {
                        likeBtn.innerHTML = '<i class="fa fa-heart text-red-500"></i><span>已点赞</span>';
                        likeBtn.classList.add('text-red-500');
                        likeBtn.classList.remove('text-neutral-500', 'hover:text-primary');
                    } else {
                        likeBtn.innerHTML = '<i class="fa fa-heart-o"></i><span>点赞</span>';
                        likeBtn.classList.remove('text-red-500');
                        likeBtn.classList.add('text-neutral-500', 'hover:text-primary');
                    }
                }
                
                // 保存更新
                await savePost(post);
            }
        }

        // 处理显示评论
        async function handleShowComments(postId) {
            const post = posts.find(post => post.id === postId);
            if (post) {
                currentPostId = postId;
                
                // 清空评论容器
                commentsContainer.innerHTML = '';
                
                // 渲染评论
                if (post.comments && post.comments.length > 0) {
                    post.comments.forEach(comment => {
                        const commentElement = createCommentElement(comment);
                        commentsContainer.appendChild(commentElement);
                    });
                } else {
                    commentsContainer.innerHTML = `
                        <div class="text-center py-8 text-neutral-400">
                            <i class="fa fa-comment-o text-3xl mb-2"></i>
                            <p>暂无评论</p>
                        </div>
                    `;
                }
                
                // 显示模态框
                commentsModal.classList.remove('hidden');
                
                // 聚焦到评论输入框
                commentInput.focus();
            }
        }

        // 创建评论元素
        function createCommentElement(comment) {
            const commentDate = new Date(comment.timestamp);
            const formattedDate = commentDate.toLocaleString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const commentElement = document.createElement('div');
            commentElement.className = 'flex items-start space-x-2 animate-fade-in';
            commentElement.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-neutral-200 flex items-center justify-center text-neutral-500 flex-shrink-0">
                    <i class="fa fa-user"></i>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between">
                        <p class="text-sm font-medium text-neutral-700">评论者</p>
                        <p class="text-xs text-neutral-400">${formattedDate}</p>
                    </div>
                    <p class="text-sm text-neutral-600">${comment.text}</p>
                </div>
            `;
            
            return commentElement;
        }

        // 添加新评论
        async function handleAddComment() {
            const commentText = commentInput.value.trim();
            if (!commentText) return;
            
            const post = posts.find(post => post.id === currentPostId);
            if (post) {
                // 创建新评论
                const newComment = {
                    id: Date.now().toString(),
                    text: commentText,
                    timestamp: Date.now()
                };
                
                // 添加到评论列表
                if (!post.comments) post.comments = [];
                post.comments.push(newComment);
                
                // 保存更新
                await savePost(post);
                
                // 更新UI
                const commentElement = createCommentElement(newComment);
                commentsContainer.appendChild(commentElement);
                
                // 清空输入框
                commentInput.value = '';
                
                // 滚动到底部
                commentsContainer.scrollTop = commentsContainer.scrollHeight;
            }
        }

        // 打开添加动态模态框
        function openAddPostModal() {
            // 清空表单
            postContent.value = '';
            imagePreviews.innerHTML = '';
            imagePreviews.classList.add('hidden');
            fileUpload.value = '';
            
            // 显示模态框
            addPostModal.classList.remove('hidden');
            
            // 聚焦到文本输入框
            postContent.focus();
        }

        // 关闭添加动态模态框
        function closeAddPostModal() {
            // 彻底清空图片相关状态
            postContent.value = '';
            imagePreviews.innerHTML = '';
            imagePreviews.classList.add('hidden');
            fileUpload.value = '';
            
            addPostModal.classList.add('hidden');
        }

        // 关闭评论模态框
        function closeCommentsModal() {
            commentsModal.classList.add('hidden');
            currentPostId = null;
        }

        // 保存新动态
        async function handleSavePost() {
            const content = postContent.value.trim();
            const imageElements = imagePreviews.querySelectorAll('img');
            const imageUrls = Array.from(imageElements).map(img => img.src);
            
            // 验证
            if (!content && imageUrls.length === 0) {
                alert('请输入内容或选择图片');
                return;
            }
            
            // 创建新动态
            const newPost = {
                id: Date.now().toString(),
                content: content,
                imageUrls: imageUrls,
                timestamp: Date.now(),
                liked: false,
                comments: []
            };
            
            // 保存到数据库
            const saved = await savePost(newPost);
            
            if (saved) {
                // 添加到数组
                posts.unshift(newPost);
                
                // 更新显示
                updatePostsDisplay();
                
                // 更新时间线筛选器
                updateTimelineFilters();
                
                // 关闭模态框
                closeAddPostModal();
            }
        }

        // 预览图片
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            // 限制最多9张图片
            const validFiles = Array.from(files).slice(0, 9);
            
            if (files.length > 9) {
                alert('最多只能上传9张图片');
            }
            
            // 清空现有预览
            imagePreviews.innerHTML = '';
            
            // 添加新预览
            validFiles.forEach(file => {
                // 验证文件类型
                const fileType = file.type;
                if (!fileType.startsWith('image/')) {
                    alert('请选择图片文件');
                    return;
                }
                
                // 创建图片预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewWrapper = document.createElement('div');
                    previewWrapper.className = 'relative';
                    
                    const previewImg = document.createElement('img');
                    previewImg.src = e.target.result;
                    previewImg.className = 'w-full h-auto rounded-lg';
                    previewImg.alt = '预览图片';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors';
                    removeBtn.innerHTML = '<i class="fa fa-times"></i>';
                    removeBtn.addEventListener('click', () => {
                        previewWrapper.remove();
                        if (imagePreviews.children.length === 0) {
                            imagePreviews.classList.add('hidden');
                        }
                    });
                    
                    previewWrapper.appendChild(previewImg);
                    previewWrapper.appendChild(removeBtn);
                    imagePreviews.appendChild(previewWrapper);
                };
                reader.readAsDataURL(file);
            });
            
            // 显示预览容器
            if (validFiles.length > 0) {
                imagePreviews.classList.remove('hidden');
            }
        }

        // 初始化应用
        async function initApp() {
            try {
                console.log('应用初始化开始...');
                
                // 初始化数据库
                await initDatabase();
                
                // 加载动态
                await loadPosts();
                
                // 更新显示
                updatePostsDisplay();
                
                // 添加事件监听器
                addPostBtn.addEventListener('click', openAddPostModal);
                emptyAddBtn.addEventListener('click', openAddPostModal);
                closeModalBtn.addEventListener('click', closeAddPostModal);
                savePostBtn.addEventListener('click', handleSavePost);
                fileUpload.addEventListener('change', handleImageUpload);
                closeCommentsBtn.addEventListener('click', closeCommentsModal);
                addCommentBtn.addEventListener('click', handleAddComment);
                commentInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleAddComment();
                    }
                });
                
                // 图片查看器事件
                closeImageViewer.addEventListener('click', closeImageViewerModal);
                prevImageBtn.addEventListener('click', showPrevImage);
                nextImageBtn.addEventListener('click', showNextImage);
                
                // 视图切换事件
                timelineViewBtn.addEventListener('click', switchToTimelineView);
                listViewBtn.addEventListener('click', switchToListView);
                closeTimelineFilter.addEventListener('click', () => {
                    timelineFilter.classList.add('hidden');
                });
                
                // 点击模态框外部关闭
                addPostModal.addEventListener('click', (e) => {
                    if (e.target === addPostModal) {
                        closeAddPostModal();
                    }
                });
                
                commentsModal.addEventListener('click', (e) => {
                    if (e.target === commentsModal) {
                        closeCommentsModal();
                    }
                });
                
                imageViewerModal.addEventListener('click', (e) => {
                    if (e.target === imageViewerModal) {
                        closeImageViewerModal();
                    }
                });
                
                // 显示初始空状态
                updatePostsDisplay();
                
                console.log('应用初始化完成');
            } catch (error) {
                console.error('应用初始化失败:', error);
                alert('应用初始化失败: ' + error.message);
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
