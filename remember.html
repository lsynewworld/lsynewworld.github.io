<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的朋友圈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#4080FF',
                        neutral: {
                            100: '#F5F7FA',
                            200: '#E5E6EB',
                            300: '#C9CDD4',
                            400: '#86909C',
                            500: '#4E5969',
                            600: '#272E3B',
                            700: '#1D2129',
                        }
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            }
            .hover-scale {
                transition: transform 0.2s ease;
            }
            .hover-scale:hover {
                transform: scale(1.02);
            }
            .animate-fade-in {
                animation: fadeIn 0.3s ease-in-out;
            }
            .image-grid {
                display: grid;
                grid-gap: 4px;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .timeline-item::before {
                content: '';
                position: absolute;
                left: 24px;
                top: 0;
                bottom: 0;
                width: 2px;
                background-color: #E5E6EB;
            }
            .timeline-dot {
                position: absolute;
                left: 18px;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background-color: #165DFF;
                z-index: 10;
            }
        }
    </style>
</head>
<body class="bg-neutral-100 font-inter text-neutral-700 min-h-screen">
    <!-- 密码验证模态框 -->
    <div id="password-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden shadow-xl animate-fade-in p-8">
            <h3 class="text-lg font-semibold text-neutral-700 mb-4">请输入密码</h3>
            <input id="password-input" type="password" class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all mb-4">
            <button id="password-submit" class="w-full bg-primary hover:bg-secondary text-white font-medium py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg">提交</button>
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50 hidden">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-primary flex items-center">
                    <i class="fa fa-paper-plane-o mr-2"></i>
                    <span>我的朋友圈</span>
                </h1>
                <div class="flex space-x-2">
                    <button id="timeline-view-btn" class="px-3 py-1 rounded-md text-sm bg-primary text-white">时间线</button>
                    <button id="list-view-btn" class="px-3 py-1 rounded-md text-sm bg-neutral-200 text-neutral-600">列表</button>
                </div>
            </div>
            <button id="add-post-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-full flex items-center transition-all duration-300 shadow-md hover:shadow-lg">
                <i class="fa fa-plus-circle mr-2"></i>
                <span>发动态</span>
            </button>
        </div>
    </header>

    <!-- 筛选器 -->
    <div id="timeline-filter" class="fixed top-16 left-0 right-0 bg-white border-b border-neutral-200 z-40 px-4 py-2 hidden">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex space-x-2 overflow-x-auto pb-1 hide-scrollbar">
                <button class="time-filter-btn px-3 py-1 rounded-md text-sm bg-primary text-white whitespace-nowrap">全部</button>
                <!-- 时间筛选按钮将通过JavaScript动态添加 -->
            </div>
            <button id="close-timeline-filter" class="text-neutral-500 hover:text-neutral-700">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-16 hidden">
        <!-- 动态列表视图 -->
        <div id="posts-container" class="max-w-4xl mx-auto space-y-6">
            <!-- 动态内容将通过JavaScript动态添加 -->
        </div>

        <!-- 时间线视图 -->
        <div id="timeline-container" class="max-w-4xl mx-auto space-y-8 pt-6 hidden">
            <!-- 时间线内容将通过JavaScript动态添加 -->
        </div>

        <!-- 空状态 -->
        <div id="empty-state" class="max-w-4xl mx-auto py-16 text-center hidden">
            <div class="bg-white rounded-xl p-8 shadow-lg max-w-md mx-auto">
                <div class="text-neutral-400 text-6xl mb-4">
                    <i class="fa fa-file-text-o"></i>
                </div>
                <h3 class="text-xl font-semibold text-neutral-600 mb-2">暂无动态</h3>
                <p class="text-neutral-500 mb-6">点击上方"发动态"按钮，开始记录你的生活点滴</p>
                <button id="empty-add-btn" class="bg-primary hover:bg-secondary text-white px-6 py-3 rounded-full flex items-center mx-auto transition-all duration-300 shadow-md hover:shadow-lg">
                    <i class="fa fa-plus-circle mr-2"></i>
                    <span>发第一条动态</span>
                </button>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-neutral-200 py-4 hidden">
        <div class="container mx-auto px-4 text-center text-neutral-500 text-sm">
            <p>© 2025 我的朋友圈应用 | 所有内容保存在本地</p>
        </div>
    </footer>

    <!-- 新增动态模态框 -->
    <div id="add-post-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden shadow-xl animate-fade-in h-[90vh] flex flex-col">
            <div class="border-b border-neutral-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-neutral-700">发布动态</h3>
                <button id="close-modal-btn" class="text-neutral-500 hover:text-neutral-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-4">
                    <textarea id="post-content" rows="4" placeholder="分享你的想法..." class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-neutral-700 mb-2">添加图片 (最多9张)</label>
                    <div class="flex items-center justify-center w-full">
                        <label for="file-upload" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-neutral-300 rounded-lg cursor-pointer bg-neutral-100 hover:bg-neutral-200 transition-all">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fa fa-cloud-upload text-3xl text-neutral-400 mb-2"></i>
                                <p class="mb-2 text-sm text-neutral-500"><span class="font-medium">点击上传图片</span> 或拖放</p>
                                <p class="text-xs text-neutral-400">支持 PNG, JPG, GIF 格式</p>
                            </div>
                            <input id="file-upload" type="file" accept="image/*" multiple class="hidden" />
                        </label>
                    </div>
                    <div id="image-previews" class="mt-4 grid grid-cols-3 gap-2 hidden">
                        <!-- 图片预览将通过JavaScript动态添加 -->
                    </div>
                </div>
            </div>
            <div class="border-t border-neutral-200 p-4">
                <button id="save-post-btn" class="w-full bg-primary hover:bg-secondary text-white font-medium py-3 px-4 rounded-lg transition-all shadow-md hover:shadow-lg">
                    发布
                </button>
            </div>
        </div>
    </div>

    <!-- 评论模态框 -->
    <div id="comments-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl w-full max-w-lg mx-4 overflow-hidden shadow-xl animate-fade-in h-[80vh] flex flex-col">
            <div class="border-b border-neutral-200 px-6 py-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-neutral-700">评论</h3>
                <button id="close-comments-btn" class="text-neutral-500 hover:text-neutral-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="comments-container" class="flex-1 overflow-y-auto p-6 space-y-4">
                <!-- 评论内容将通过JavaScript动态添加 -->
            </div>
            <div class="border-t border-neutral-200 p-4">
                <div class="flex items-center space-x-2">
                    <input id="comment-input" type="text" placeholder="添加评论..." class="flex-1 px-4 py-2 border border-neutral-300 rounded-full focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                    <button id="add-comment-btn" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-full transition-all">
                        <i class="fa fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div id="image-viewer-modal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden">
        <div class="relative w-full max-w-4xl px-4">
            <button id="close-image-viewer" class="absolute top-4 right-4 text-white text-2xl hover:text-neutral-300">
                <i class="fa fa-times"></i>
            </button>
            <div class="flex items-center justify-between h-full">
                <button id="prev-image" class="absolute left-4 text-white text-3xl hover:text-neutral-300">
                    <i class="fa fa-angle-left"></i>
                </button>
                <img id="fullsize-image" class="max-h-[80vh] max-w-full object-contain" alt="大图预览">
                <button id="next-image" class="absolute right-4 text-white text-3xl hover:text-neutral-300">
                    <i class="fa fa-angle-right"></i>
                </button>
            </div>
            <div class="absolute bottom-4 left-0 right-0 text-center text-white">
                <span id="image-caption"></span>
                <span id="image-counter" class="ml-2 text-sm"></span>
            </div>
        </div>
    </div>

    <script>
        // 定义正确的密码
        const CORRECT_PASSWORD = "5566lsylsy";
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmit = document.getElementById('password-submit');
        const mainElements = document.querySelectorAll('header, #timeline-filter, main, footer');

        // 密码验证
        passwordSubmit.addEventListener('click', function() {
            const inputPassword = passwordInput.value;
            if (inputPassword === CORRECT_PASSWORD) {
                passwordModal.style.display = 'none';
                mainElements.forEach(element => {
                    element.classList.remove('hidden');
                });
                initApp();
            } else {
                alert('密码错误，请重新输入。');
            }
        });

        // 数据结构
        let posts = [];
        let currentPostId = null;
        let currentImageIndex = 0;
        let currentImages = [];
        let db = null;
        let accountName = '我的账号'; // 默认账号名
        let currentView = 'list'; // 'list' 或 'timeline'
        let currentFilter = 'all'; // 默认显示所有

        // DOM 元素
        const postsContainer = document.getElementById('posts-container');
        const timelineContainer = document.getElementById('timeline-container');
        const emptyState = document.getElementById('empty-state');
        const addPostBtn = document.getElementById('add-post-btn');
        const emptyAddBtn = document.getElementById('empty-add-btn');
        const addPostModal = document.getElementById('add-post-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const postContent = document.getElementById('post-content');
        const fileUpload = document.getElementById('file-upload');
        const imagePreviews = document.getElementById('image-previews');
        const savePostBtn = document.getElementById('save-post-btn');
        const commentsModal = document.getElementById('comments-modal');
        const closeCommentsBtn = document.getElementById('close-comments-btn');
        const commentsContainer = document.getElementById('comments-container');
        const commentInput = document.getElementById('comment-input');
        const addCommentBtn = document.getElementById('add-comment-btn');
        const imageViewerModal = document.getElementById('image-viewer-modal');
        const closeImageViewer = document.getElementById('close-image-viewer');
        const fullsizeImage = document.getElementById('fullsize-image');
        const imageCaption = document.getElementById('image-caption');
        const imageCounter = document.getElementById('image-counter');
        const prevImageBtn = document.getElementById('prev-image');
        const nextImageBtn = document.getElementById('next-image');
        const timelineViewBtn = document.getElementById('timeline-view-btn');
        const listViewBtn = document.getElementById('list-view-btn');
        const timelineFilter = document.getElementById('timeline-filter');
        const closeTimelineFilter = document.getElementById('close-timeline-filter');

        // 初始化IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                console.log('尝试打开数据库...');
                const request = indexedDB.open('FriendCircleDB', 1);
                
                request.onupgradeneeded = function(event) {
                    console.log('数据库升级中...');
                    db = event.target.result;
                    
                    // 创建对象存储空间
                    if (!db.objectStoreNames.contains('posts')) {
                        const objectStore = db.createObjectStore('posts', { keyPath: 'id' });
                        
                        // 创建索引
                        objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                        console.log('创建了posts对象存储空间');
                    }
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('数据库初始化成功');
                    resolve();
                };
                
                request.onerror = function(event) {
                    console.error('数据库打开失败:', event.target.error);
                    alert('数据库初始化失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
                
                request.onblocked = function(event) {
                    console.error('数据库被阻塞:', event.target.error);
                    alert('数据库被占用，请关闭其他打开此数据库的页面后重试');
                    reject(event.target.error);
                };
            });
        }

        // 加载已保存的动态
        async function loadPosts() {
            posts = [];
            
            return new Promise((resolve, reject) => {
                console.log('尝试加载动态...');
                if (!db) {
                    console.error('数据库未初始化');
                    reject(new Error('数据库未初始化'));
                    return;
                }
                
                const transaction = db.transaction(['posts'], 'readonly');
                const objectStore = transaction.objectStore('posts');
                const request = objectStore.getAll();
                
                request.onsuccess = function(event) {
                    posts = event.target.result || [];
                    console.log(`成功加载 ${posts.length} 条动态`);
                    
                    // 按时间戳排序（最新的在前）
                    posts.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // 更新时间线筛选器
                    updateTimelineFilters();
                    
                    // 渲染动态
                    renderPosts();
                    
                    resolve();
                };
                
                request.onerror = function(event) {
                    console.error('加载动态失败:', event.target.error);
                    alert('加载动态失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
            });
        }

        // 保存动态到IndexedDB
        async function savePost(postData) {
            return new Promise((resolve, reject) => {
                console.log('尝试保存动态...');
                if (!db) {
                    console.error('数据库未初始化');
                    reject(new Error('数据库未初始化'));
                    return;
                }
                
                const transaction = db.transaction(['posts'], 'readwrite');
                const objectStore = transaction.objectStore('posts');
                const request = objectStore.put(postData);
                
                request.onsuccess = function(event) {
                    console.log('动态保存成功');
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('保存动态失败:', event.target.error);
                    alert('保存动态失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
            });
        }

        // 删除动态
        async function deletePost(postId) {
            return new Promise((resolve, reject) => {
                console.log('尝试删除动态...');
                if (!db) {
                    console.error('数据库未初始化');
                    reject(new Error('数据库未初始化'));
                    return;
                }
                
                const transaction = db.transaction(['posts'], 'readwrite');
                const objectStore = transaction.objectStore('posts');
                const request = objectStore.delete(postId);
                
                request.onsuccess = function(event) {
                    console.log('动态删除成功');
                    // 从内存中删除
                    posts = posts.filter(post => post.id !== postId);
                    // 重新渲染
                    renderPosts();
                    resolve(true);
                };
                
                request.onerror = function(event) {
                    console.error('删除动态失败:', event.target.error);
                    alert('删除动态失败: ' + event.target.error.message);
                    reject(event.target.error);
                };
            });
        }

        // 更新时间线筛选器
        function updateTimelineFilters() {
            const timeFilterContainer = timelineFilter.querySelector('.time-filter-btn').parentNode;
            timeFilterContainer.innerHTML = '';
            
            // 添加"全部"按钮
            const allBtn = document.createElement('button');
            allBtn.className = 'time-filter-btn px-3 py-1 rounded-md text-sm bg-primary text-white whitespace-nowrap';
            allBtn.textContent = '全部';
            allBtn.addEventListener('click', () => {
                setTimelineFilter('all');
            });
            timeFilterContainer.appendChild(allBtn);
            
            // 收集所有年月
            const yearMonths = new Set();
            posts.forEach(post => {
                const date = new Date(post.timestamp);
                const yearMonth = `${date.getFullYear()}年${date.getMonth() + 1}月`;
                yearMonths.add(yearMonth);
            });
            
            // 添加年月筛选按钮
            yearMonths.forEach(yearMonth => {
                const btn = document.createElement('button');
                btn.className = 'time-filter-btn px-3 py-1 rounded-md text-sm bg-neutral-200 text-neutral-600 whitespace-nowrap';
                btn.textContent = yearMonth;
                btn.addEventListener('click', () => {
                    setTimelineFilter(yearMonth);
                });
                timeFilterContainer.appendChild(btn);
            });
        }

        // 设置时间线筛选器
        function setTimelineFilter(filter) {
            currentFilter = filter;
            // 更新按钮样式
            document.querySelectorAll('.time-filter-btn').forEach(btn => {
                if (btn.textContent === filter || (filter === 'all' && btn.textContent === '全部')) {
                    btn.classList.remove('bg-neutral-200', 'text-neutral-600');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-neutral-200', 'text-neutral-600');
                }
            });
            // 重新渲染动态
            renderPosts();
        }

        // 渲染动态
        function renderPosts() {
            // 清空容器
            postsContainer.innerHTML = '';
            timelineContainer.innerHTML = '';
            
            // 应用筛选器
            let filteredPosts = posts;
            if (currentFilter !== 'all') {
                const year = parseInt(currentFilter);
                const month = parseInt(currentFilter.split('年')[1].split('月')[0]) - 1;
                filteredPosts = posts.filter(post => {
                    const date = new Date(post.timestamp);
                    return date.getFullYear() === year && date.getMonth() === month;
                });
            }
            
            // 检查是否有动态
            if (filteredPosts.length === 0) {
                emptyState.classList.remove('hidden');
                postsContainer.classList.add('hidden');
                timelineContainer.classList.add('hidden');
                return;
            }
            
            // 隐藏空状态
            emptyState.classList.add('hidden');
            
            // 根据当前视图渲染
            if (currentView === 'list') {
                postsContainer.classList.remove('hidden');
                timelineContainer.classList.add('hidden');
                
                // 渲染列表视图
                filteredPosts.forEach(post => {
                    const postElement = createPostElement(post);
                    postsContainer.appendChild(postElement);
                });
            } else {
                postsContainer.classList.add('hidden');
                timelineContainer.classList.remove('hidden');
                
                // 按日期分组
                const postsByDate = {};
                filteredPosts.forEach(post => {
                    const date = new Date(post.timestamp);
                    const dateString = date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                    if (!postsByDate[dateString]) {
                        postsByDate[dateString] = [];
                    }
                    postsByDate[dateString].push(post);
                });
                
                // 渲染时间线视图
                Object.keys(postsByDate).forEach(dateString => {
                    const dateGroup = document.createElement('div');
                    dateGroup.className = 'relative pl-12';
                    
                    // 添加日期标题
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'timeline-dot mt-1';
                    dateHeader.innerHTML = `
                        <div class="ml-8 text-sm font-medium text-neutral-500">${dateString}</div>
                    `;
                    dateGroup.appendChild(dateHeader);
                    
                    // 添加该日期的所有动态
                    const postsWrapper = document.createElement('div');
                    postsWrapper.className = 'mt-4 ml-8 space-y-6';
                    postsByDate[dateString].forEach(post => {
                        const postElement = createPostElement(post);
                        postsWrapper.appendChild(postElement);
                    });
                    dateGroup.appendChild(postsWrapper);
                    
                    timelineContainer.appendChild(dateGroup);
                });
            }
        }

        // 创建动态元素
        function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'bg-white rounded-xl p-4 md:p-6 card-shadow hover-scale animate-fade-in';
            postElement.setAttribute('data-post-id', post.id);
            
            // 格式化日期
            const date = new Date(post.timestamp);
            const formattedDate = date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // 构建评论HTML
            let commentsHtml = '';
            if (post.comments && post.comments.length > 0) {
                commentsHtml = '<div class="mt-4 pt-4 border-t border-neutral-100">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="flex items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <span class="font-medium text-neutral-700">${comment.author}</span>
                                    <span class="ml-2 text-xs text-neutral-400">${formatCommentTime(comment.timestamp)}</span>
                                </div>
                                <p class="text-neutral-600 mt-1">${comment.content}</p>
                            </div>
                            <button class="delete-comment-btn text-red-500 text-sm" data-comment-id="${comment.id}">删除</button>
                        </div>
                    `;
                });
                commentsHtml += '</div>';
            }
            
            // 构建图片HTML
            let imagesHtml = '';
            if (post.images && post.images.length > 0) {
                imagesHtml = '<div class="mt-4 image-grid">';
                post.images.forEach((image, index) => {
                    imagesHtml += `
                        <div class="relative group overflow-hidden rounded-lg cursor-pointer" data-index="${index}">
                            <img src="${image}" alt="动态图片" class="w-full h-24 md:h-32 object-cover transition-transform duration-300 group-hover:scale-110">
                        </div>
                    `;
                });
                imagesHtml += '</div>';
            }
            
            // 设置动态内容
            postElement.innerHTML = `
                <div class="flex items-start">
                    <img src="https://picsum.photos/seed/avatar${post.id}/48/48" alt="用户头像" class="w-10 h-10 rounded-full mr-3">
                    <div class="flex-1">
                        <div class="flex justify-between">
                            <h3 class="font-medium text-neutral-700">${accountName}</h3>
                            <span class="text-xs text-neutral-400">${formattedDate}</span>
                        </div>
                        <p class="text-neutral-600 mt-1">${post.content}</p>
                        ${imagesHtml}
                        <div class="mt-4 flex justify-between items-center">
                            <div class="flex space-x-4">
                                <button class="like-btn flex items-center text-neutral-500 hover:text-red-500 transition-colors" data-liked="${post.liked || false}">
                                    <i class="fa fa-heart-o mr-1"></i>
                                    <span>${post.likes || 0}</span>
                                </button>
                                <button class="comment-btn flex items-center text-neutral-500 hover:text-primary transition-colors">
                                    <i class="fa fa-comment-o mr-1"></i>
                                    <span>${post.comments ? post.comments.length : 0}</span>
                                </button>
                            </div>
                            <button class="delete-post-btn text-neutral-400 hover:text-neutral-700">
                                <i class="fa fa-trash-o"></i>
                            </button>
                        </div>
                        ${commentsHtml}
                    </div>
                </div>
            `;
            
            // 添加事件监听器
            const likeBtn = postElement.querySelector('.like-btn');
            likeBtn.addEventListener('click', function() {
                toggleLike(post.id);
            });
            
            const commentBtn = postElement.querySelector('.comment-btn');
            commentBtn.addEventListener('click', function() {
                openComments(post.id);
            });
            
            const deleteBtn = postElement.querySelector('.delete-post-btn');
            deleteBtn.addEventListener('click', function() {
                if (confirm('确定要删除这条动态吗？')) {
                    deletePost(post.id);
                }
            });
            
            // 为图片添加点击事件
            const imageElements = postElement.querySelectorAll('.image-grid > div');
            imageElements.forEach(element => {
                element.addEventListener('click', function() {
                    openImageViewer(post.images, parseInt(this.getAttribute('data-index')));
                });
            });
            
            // 为删除评论按钮添加事件
            const deleteCommentBtns = postElement.querySelectorAll('.delete-comment-btn');
            deleteCommentBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    deleteComment(post.id, commentId);
                });
            });
            
            return postElement;
        }

        // 格式化评论时间
        function formatCommentTime(timestamp) {
            const now = new Date();
            const commentDate = new Date(timestamp);
            const diffMs = now - commentDate;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffDay > 0) {
                return `${diffDay}天前`;
            } else if (diffHour > 0) {
                return `${diffHour}小时前`;
            } else if (diffMin > 0) {
                return `${diffMin}分钟前`;
            } else {
                return `${diffSec}秒前`;
            }
        }

        // 切换点赞状态
        function toggleLike(postId) {
            const post = posts.find(p => p.id === postId);
            if (post) {
                post.liked = !post.liked;
                if (post.liked) {
                    post.likes = (post.likes || 0) + 1;
                } else {
                    post.likes = (post.likes || 1) - 1;
                }
                savePost(post).then(() => {
                    renderPosts();
                });
            }
        }

        // 打开评论模态框
        function openComments(postId) {
            currentPostId = postId;
            const post = posts.find(p => p.id === postId);
            
            // 清空并填充评论
            commentsContainer.innerHTML = '';
            
            if (post && post.comments && post.comments.length > 0) {
                post.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'flex items-start justify-between';
                    commentElement.innerHTML = `
                        <div>
                            <div class="flex items-center">
                                <span class="font-medium text-neutral-700">${comment.author}</span>
                                <span class="ml-2 text-xs text-neutral-400">${formatCommentTime(comment.timestamp)}</span>
                            </div>
                            <p class="text-neutral-600 mt-1">${comment.content}</p>
                        </div>
                        <button class="delete-comment-btn text-red-500 text-sm" data-comment-id="${comment.id}">删除</button>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            } else {
                commentsContainer.innerHTML = `
                    <div class="text-center py-8 text-neutral-400">
                        <i class="fa fa-comment-o text-2xl mb-2"></i>
                        <p>暂无评论，添加一条评论吧</p>
                    </div>
                `;
            }
            
            // 显示模态框
            commentsModal.classList.remove('hidden');
        }

        // 添加评论
        function addComment(content) {
            if (!currentPostId || !content.trim()) return;
            
            const post = posts.find(p => p.id === currentPostId);
            if (!post) return;
            
            // 创建新评论
            const newComment = {
                id: Date.now().toString(),
                author: accountName,
                content: content.trim(),
                timestamp: Date.now()
            };
            
            // 添加到数组
            if (!post.comments) {
                post.comments = [];
            }
            post.comments.push(newComment);
            
            // 保存到数据库
            savePost(post).then(() => {
                // 更新评论列表
                commentsContainer.innerHTML = '';
                post.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'flex items-start justify-between';
                    commentElement.innerHTML = `
                        <div>
                            <div class="flex items-center">
                                <span class="font-medium text-neutral-700">${comment.author}</span>
                                <span class="ml-2 text-xs text-neutral-400">${formatCommentTime(comment.timestamp)}</span>
                            </div>
                            <p class="text-neutral-600 mt-1">${comment.content}</p>
                        </div>
                        <button class="delete-comment-btn text-red-500 text-sm" data-comment-id="${comment.id}">删除</button>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
                
                // 清空输入框
                commentInput.value = '';
                
                // 为新添加的删除按钮添加事件监听器
                const deleteButtons = commentsContainer.querySelectorAll('.delete-comment-btn');
                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const commentId = this.getAttribute('data-comment-id');
                        deleteComment(currentPostId, commentId);
                    });
                });
            });
        }

        // 删除评论
        function deleteComment(postId, commentId) {
            const post = posts.find(p => p.id === postId);
            if (!post || !post.comments) return;
            
            // 从数组中删除评论
            post.comments = post.comments.filter(comment => comment.id !== commentId);
            
            // 保存到数据库
            savePost(post).then(() => {
                // 更新评论列表
                commentsContainer.innerHTML = '';
                
                if (post.comments && post.comments.length > 0) {
                    post.comments.forEach(comment => {
                        const commentElement = document.createElement('div');
                        commentElement.className = 'flex items-start justify-between';
                        commentElement.innerHTML = `
                            <div>
                                <div class="flex items-center">
                                    <span class="font-medium text-neutral-700">${comment.author}</span>
                                    <span class="ml-2 text-xs text-neutral-400">${formatCommentTime(comment.timestamp)}</span>
                                </div>
                                <p class="text-neutral-600 mt-1">${comment.content}</p>
                            </div>
                            <button class="delete-comment-btn text-red-500 text-sm" data-comment-id="${comment.id}">删除</button>
                        `;
                        commentsContainer.appendChild(commentElement);
                    });
                    
                    // 为删除按钮添加事件监听器
                    const deleteButtons = commentsContainer.querySelectorAll('.delete-comment-btn');
                    deleteButtons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            const commentId = this.getAttribute('data-comment-id');
                            deleteComment(postId, commentId);
                        });
                    });
                } else {
                    commentsContainer.innerHTML = `
                        <div class="text-center py-8 text-neutral-400">
                            <i class="fa fa-comment-o text-2xl mb-2"></i>
                            <p>暂无评论，添加一条评论吧</p>
                        </div>
                    `;
                }
            });
        }

        // 打开图片查看器
        function openImageViewer(images, startIndex) {
            currentImages = images;
            currentImageIndex = startIndex;
            
            // 设置当前图片
            updateImageViewer();
            
            // 显示模态框
            imageViewerModal.classList.remove('hidden');
        }

        // 更新图片查看器
        function updateImageViewer() {
            if (!currentImages || currentImages.length === 0) return;
            
            fullsizeImage.src = currentImages[currentImageIndex];
            fullsizeImage.alt = `动态图片 ${currentImageIndex + 1}`;
            imageCaption.textContent = `图片 ${currentImageIndex + 1}`;
            imageCounter.textContent = `共 ${currentImages.length} 张`;
        }

        // 初始化应用
        async function initApp() {
            await initDatabase();
            await loadPosts();
            
            // 设置视图切换
            timelineViewBtn.addEventListener('click', function() {
                currentView = 'timeline';
                timelineViewBtn.classList.remove('bg-neutral-200', 'text-neutral-600');
                timelineViewBtn.classList.add('bg-primary', 'text-white');
                listViewBtn.classList.remove('bg-primary', 'text-white');
                listViewBtn.classList.add('bg-neutral-200', 'text-neutral-600');
                renderPosts();
            });
            
            listViewBtn.addEventListener('click', function() {
                currentView = 'list';
                listViewBtn.classList.remove('bg-neutral-200', 'text-neutral-600');
                listViewBtn.classList.add('bg-primary', 'text-white');
                timelineViewBtn.classList.remove('bg-primary', 'text-white');
                timelineViewBtn.classList.add('bg-neutral-200', 'text-neutral-600');
                renderPosts();
            });
            
            // 显示时间线筛选器
            timelineViewBtn.addEventListener('click', function() {
                timelineFilter.classList.remove('hidden');
            });
            
            // 关闭时间线筛选器
            closeTimelineFilter.addEventListener('click', function() {
                timelineFilter.classList.add('hidden');
            });
            
            // 模态框相关事件
            addPostBtn.addEventListener('click', function() {
                openAddPostModal();
            });
            
            emptyAddBtn.addEventListener('click', function() {
                openAddPostModal();
            });
            
            closeModalBtn.addEventListener('click', function() {
                closeAddPostModal();
            });
            
            savePostBtn.addEventListener('click', function() {
                saveNewPost();
            });
            
            closeCommentsBtn.addEventListener('click', function() {
                commentsModal.classList.add('hidden');
            });
            
            addCommentBtn.addEventListener('click', function() {
                addComment(commentInput.value);
            });
            
            commentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addComment(commentInput.value);
                }
            });
            
            closeImageViewer.addEventListener('click', function() {
                imageViewerModal.classList.add('hidden');
            });
            
            prevImageBtn.addEventListener('click', function() {
                if (currentImages && currentImages.length > 0) {
                    currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
                    updateImageViewer();
                }
            });
            
            nextImageBtn.addEventListener('click', function() {
                if (currentImages && currentImages.length > 0) {
                    currentImageIndex = (currentImageIndex + 1) % currentImages.length;
                    updateImageViewer();
                }
            });
            
            // 图片上传预览
            fileUpload.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    imagePreviews.innerHTML = '';
                    imagePreviews.classList.remove('hidden');
                    
                    for (let i = 0; i < Math.min(this.files.length, 9); i++) {
                        const file = this.files[i];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            const imageContainer = document.createElement('div');
                            imageContainer.className = 'relative';
                            imageContainer.innerHTML = `
                                <img src="${e.target.result}" alt="预览图片" class="w-full h-24 object-cover rounded-lg">
                                <button class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center remove-image-btn" data-index="${i}">
                                    <i class="fa fa-times"></i>
                                </button>
                            `;
                            imagePreviews.appendChild(imageContainer);
                            
                            // 添加删除图片事件
                            const removeBtn = imageContainer.querySelector('.remove-image-btn');
                            removeBtn.addEventListener('click', function() {
                                const index = parseInt(this.getAttribute('data-index'));
                                const dt = new DataTransfer();
                                
                                for (let j = 0; j < fileUpload.files.length; j++) {
                                    if (j !== index) {
                                        dt.items.add(fileUpload.files[j]);
                                    }
                                }
                                
                                fileUpload.files = dt.files;
                                
                                // 如果没有图片了，隐藏预览区域
                                if (fileUpload.files.length === 0) {
                                    imagePreviews.classList.add('hidden');
                                }
                                
                                // 重新渲染预览
                                imagePreviews.innerHTML = '';
                                for (let k = 0; k < fileUpload.files.length; k++) {
                                    const previewFile = fileUpload.files[k];
                                    const previewReader = new FileReader();
                                    
                                    previewReader.onload = function(previewEvent) {
                                        const previewContainer = document.createElement('div');
                                        previewContainer.className = 'relative';
                                        previewContainer.innerHTML = `
                                            <img src="${previewEvent.target.result}" alt="预览图片" class="w-full h-24 object-cover rounded-lg">
                                            <button class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center remove-image-btn" data-index="${k}">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        `;
                                        imagePreviews.appendChild(previewContainer);
                                        
                                        // 为新添加的删除按钮添加事件
                                        const newRemoveBtn = previewContainer.querySelector('.remove-image-btn');
                                        newRemoveBtn.addEventListener('click', function() {
                                            const newIndex = parseInt(this.getAttribute('data-index'));
                                            const newDt = new DataTransfer();
                                            
                                            for (let m = 0; m < fileUpload.files.length; m++) {
                                                if (m !== newIndex) {
                                                    newDt.items.add(fileUpload.files[m]);
                                                }
                                            }
                                            
                                            fileUpload.files = newDt.files;
                                            
                                            if (fileUpload.files.length === 0) {
                                                imagePreviews.classList.add('hidden');
                                            }
                                            
                                            // 重新渲染预览
                                            imagePreviews.innerHTML = '';
                                            for (let n = 0; n < fileUpload.files.length; n++) {
                                                const finalFile = fileUpload.files[n];
                                                const finalReader = new FileReader();
                                                
                                                finalReader.onload = function(finalEvent) {
                                                    const finalContainer = document.createElement('div');
                                                    finalContainer.className = 'relative';
                                                    finalContainer.innerHTML = `
                                                        <img src="${finalEvent.target.result}" alt="预览图片" class="w-full h-24 object-cover rounded-lg">
                                                        <button class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center remove-image-btn" data-index="${n}">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    `;
                                                    imagePreviews.appendChild(finalContainer);
                                                    
                                                    // 为新添加的删除按钮添加事件
                                                    const finalRemoveBtn = finalContainer.querySelector('.remove-image-btn');
                                                    finalRemoveBtn.addEventListener('click', function() {
                                                        // 递归处理删除
                                                        const finalIndex = parseInt(this.getAttribute('data-index'));
                                                        const finalDt = new DataTransfer();
                                                        
                                                        for (let p = 0; p < fileUpload.files.length; p++) {
                                                            if (p !== finalIndex) {
                                                                finalDt.items.add(fileUpload.files[p]);
                                                            }
                                                        }
                                                        
                                                        fileUpload.files = finalDt.files;
                                                        
                                                        if (fileUpload.files.length === 0) {
                                                            imagePreviews.classList.add('hidden');
                                                        } else {
                                                            // 重新渲染预览
                                                            imagePreviews.innerHTML = '';
                                                            for (let q = 0; q < fileUpload.files.length; q++) {
                                                                const imgFile = fileUpload.files[q];
                                                                const imgReader = new FileReader();
                                                                
                                                                imgReader.onload = function(imgEvent) {
                                                                    const imgContainer = document.createElement('div');
                                                                    imgContainer.className = 'relative';
                                                                    imgContainer.innerHTML = `
                                                                        <img src="${imgEvent.target.result}" alt="预览图片" class="w-full h-24 object-cover rounded-lg">
                                                                        <button class="absolute top-1 right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center remove-image-btn" data-index="${q}">
                                                                            <i class="fa fa-times"></i>
                                                                        </button>
                                                                    `;
                                                                    imagePreviews.appendChild(imgContainer);
                                                                    
                                                                    // 为新添加的删除按钮添加事件
                                                                    const imgRemoveBtn = imgContainer.querySelector('.remove-image-btn');
                                                                    imgRemoveBtn.addEventListener('click', function() {
                                                                        // 再次递归处理删除...
                                                                    });
                                                                };
                                                                
                                                                imgReader.readAsDataURL(imgFile);
                                                            }
                                                        }
                                                    });
                                                };
                                                
                                                imgReader.readAsDataURL(finalFile);
                                            }
                                        });
                                    };
                                    
                                    previewReader.readAsDataURL(previewFile);
                                }
                            });
                        };
                        
                        reader.readAsDataURL(file);
                    }
                }
            });
            
            // 键盘导航
            document.addEventListener('keydown', function(e) {
                if (imageViewerModal.classList.contains('hidden')) return;
                
                if (e.key === 'ArrowLeft') {
                    prevImageBtn.click();
                } else if (e.key === 'ArrowRight') {
                    nextImageBtn.click();
                } else if (e.key === 'Escape') {
                    closeImageViewer.click();
                }
            });
        }

        // 打开添加动态模态框
        function openAddPostModal() {
            postContent.value = '';
            fileUpload.value = '';
            imagePreviews.innerHTML = '';
            imagePreviews.classList.add('hidden');
            addPostModal.classList.remove('hidden');
            postContent.focus();
        }

        // 关闭添加动态模态框
        function closeAddPostModal() {
            addPostModal.classList.add('hidden');
        }

        // 保存新动态
        async function saveNewPost() {
            const content = postContent.value.trim();
            const files = fileUpload.files;
            
            if (!content && files.length === 0) {
                alert('请输入内容或选择图片');
                return;
            }
            
            // 创建新动态
            const newPost = {
                id: Date.now().toString(),
                content: content,
                timestamp: Date.now(),
                likes: 0,
                liked: false,
                comments: []
            };
            
            // 处理图片
            if (files.length > 0) {
                newPost.images = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        newPost.images.push(e.target.result);
                        
                        // 当所有图片都处理完毕后保存动态
                        if (newPost.images.length === files.length) {
                            savePost(newPost).then(() => {
                                // 添加到内存中
                                posts.unshift(newPost);
                                
                                // 更新UI
                                closeAddPostModal();
                                updateTimelineFilters();
                                renderPosts();
                            });
                        }
                    };
                    
                    reader.readAsDataURL(file);
                }
            } else {
                // 没有图片，直接保存
                savePost(newPost).then(() => {
                    // 添加到内存中
                    posts.unshift(newPost);
                    
                    // 更新UI
                    closeAddPostModal();
                    updateTimelineFilters();
                    renderPosts();
                });
            }
        }
    </script>
</body>
</html>
